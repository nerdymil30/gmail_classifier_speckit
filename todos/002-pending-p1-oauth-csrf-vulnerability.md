---
status: pending
priority: p1
issue_id: "002"
tags: [code-review, security, critical, oauth, csrf]
dependencies: []
---

# Add OAuth CSRF Protection with State Parameter

## Problem Statement

The OAuth authentication flow lacks CSRF (Cross-Site Request Forgery) protection. No state parameter is generated or validated, allowing an attacker to link a victim's Gmail account to the attacker's application session.

**CWE:** CWE-352 (Cross-Site Request Forgery)

## Findings

**Discovered by:** security-sentinel agent during OAuth flow analysis

**Location:** `src/gmail_classifier/auth/gmail_auth.py:96-108`

**Current Code:**
```python
flow = InstalledAppFlow.from_client_secrets_file(
    str(self.credentials_path),
    scopes=Config.GMAIL_SCOPES,
    # Missing: state parameter
)

creds = flow.run_local_server(port=8080, prompt="consent")
# Missing: state validation
```

**Attack Scenario:**
1. Attacker creates malicious OAuth authorization link with their app credentials
2. Attacker tricks victim into clicking the link
3. Victim authorizes, thinking it's legitimate
4. Victim's Gmail gets linked to attacker's app session
5. Attacker gains access to victim's emails through the app

**Risk Level:** CRITICAL - Account compromise via CSRF

## Proposed Solutions

### Option 1: State Parameter with Token Validation (RECOMMENDED)
**Pros:**
- Industry standard CSRF protection
- Simple to implement with Python's secrets module
- Required by OAuth 2.0 security best practices
- Prevents session fixation attacks

**Cons:** None

**Effort:** Small (15 minutes)
**Risk:** Low

**Implementation:**
```python
import secrets

def authenticate(self, force_new: bool = False) -> Credentials:
    # Generate cryptographically secure state token
    state = secrets.token_urlsafe(32)

    flow = InstalledAppFlow.from_client_secrets_file(
        str(self.credentials_path),
        scopes=Config.GMAIL_SCOPES,
        state=state  # Add state parameter
    )

    creds = flow.run_local_server(
        port=0,
        prompt="consent",
        success_message="Authentication successful! You can close this window.",
    )

    # Validate state parameter on callback
    if flow.state != state:
        raise ValueError(
            "OAuth state mismatch detected. Possible CSRF attack. "
            "Please try authenticating again."
        )

    # Save credentials if state validated
    self._save_credentials_to_keyring(creds)
    return creds
```

### Option 2: State Parameter + PKCE (Enhanced Security)
**Pros:**
- Maximum security for OAuth flow
- PKCE (Proof Key for Code Exchange) adds additional layer
- Protects against authorization code interception
- Recommended for native/desktop apps

**Cons:**
- More complex implementation
- May require updating google-auth library

**Effort:** Medium (1 hour)
**Risk:** Low

**Implementation:**
```python
import secrets
import hashlib
import base64

def authenticate(self, force_new: bool = False) -> Credentials:
    # Generate state token
    state = secrets.token_urlsafe(32)

    # Generate PKCE code verifier and challenge
    code_verifier = secrets.token_urlsafe(96)
    code_challenge = base64.urlsafe_b64encode(
        hashlib.sha256(code_verifier.encode()).digest()
    ).decode().rstrip('=')

    flow = InstalledAppFlow.from_client_secrets_file(
        str(self.credentials_path),
        scopes=Config.GMAIL_SCOPES,
        state=state,
        code_challenge=code_challenge,
        code_challenge_method='S256'
    )

    # Continue with validation...
```

## Recommended Action

**Implement Option 1** initially for quick security fix. Consider upgrading to Option 2 (PKCE) in a future sprint for maximum security.

## Technical Details

**Affected Files:**
- `src/gmail_classifier/auth/gmail_auth.py` (lines 96-108, `authenticate` method)

**Related Components:**
- OAuth flow initialization
- User authentication workflow
- Credential validation

**Database Changes:** No

**Dependencies:**
- Python `secrets` module (standard library)
- `google-auth-oauthlib` library (already in use)

## Resources

- [OAuth 2.0 Security Best Practices - State Parameter](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics#section-4.5)
- [RFC 6749 - OAuth 2.0 State Parameter](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.1)
- [PKCE RFC 7636](https://datatracker.ietf.org/doc/html/rfc7636)
- Related findings: 001-pending-p1-oauth-port-hijacking.md

## Acceptance Criteria

- [ ] State parameter generated using `secrets.token_urlsafe(32)`
- [ ] State parameter passed to OAuth flow
- [ ] State validation implemented after callback
- [ ] ValueError raised on state mismatch with clear error message
- [ ] Unit test: State mismatch raises exception
- [ ] Unit test: Valid state allows authentication to proceed
- [ ] Security test: CSRF attack blocked by state validation
- [ ] Manual test: Authentication completes successfully 5 times
- [ ] Code reviewed and approved

## Work Log

### 2025-11-05 - Code Review Discovery
**By:** Claude Code Review System (security-sentinel agent)
**Actions:**
- Discovered during OAuth security audit
- Identified as CWE-352 vulnerability
- Marked as P1 critical priority

**Learnings:**
- State parameter is mandatory for secure OAuth flows
- CSRF is a common OAuth vulnerability in desktop apps
- Python's secrets module provides cryptographically secure token generation
